<\!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ファイルアップロードテスト</title>
</head>
<body>
    <h1>ファイルアップロードテスト</h1>
    <input type="file" id="fileInput" multiple>
    <input type="text" id="message" placeholder="メッセージ（オプション）">
    <button onclick="testUpload()">送信</button>
    <div id="result"></div>
    
    <script>
    async function testUpload() {
        const fileInput = document.getElementById('fileInput');
        const message = document.getElementById('message').value || 'ファイルを確認してください';
        const files = [];
        
        for (const file of fileInput.files) {
            const reader = new FileReader();
            const fileData = await new Promise((resolve) => {
                reader.onload = (e) => resolve(e.target.result);
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            });
            
            files.push({
                name: file.name,
                type: file.type,
                size: file.size,
                data: fileData
            });
        }
        
        console.log('送信データ:', { message, files });
        
        const response = await fetch('http://localhost:3001/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                model: 'gemini-1.5-flash',
                files: files,
                history: [],
                useKnowledge: false
            })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let result = '';
        
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        if (data.content) {
                            result += data.content;
                            document.getElementById('result').innerText = result;
                        }
                    } catch (e) {}
                }
            }
        }
    }
    </script>
</body>
</html>
