// æ‹¡å¼µç‰ˆ - å±¥æ­´ä¿æŒãƒ»ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹å¯¾å¿œ
let messages = [];
let currentChatId = generateChatId();
let chatHistory = {};
let isGenerating = false;
let availableModels = [];
let userProfile = {};
let companyKnowledge = [];

// æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ï¼ˆæ˜ç¢ºã«falseã§åˆæœŸåŒ–ï¼‰
let isKnowledgeEnabled = false;
let isVoiceEnabled = false;
let isSpeakEnabled = false;

// éŸ³å£°èªè­˜ã¨åˆæˆ
let recognition = null;
let synthesis = window.speechSynthesis;
let isRecording = false;

// DOMè¦ç´ ï¼ˆåˆæœŸåŒ–æ™‚ã«è¨­å®šï¼‰
let messagesDiv;
let messageInput;
let sendButton;
let statusElement;
let modelSelect;

// åˆæœŸåŒ–æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
function initializeApp() {
    console.log('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ä¸­...');
    
    // DOMè¦ç´ ã‚’å–å¾—
    messagesDiv = document.getElementById('messages');
    messageInput = document.getElementById('messageInput');
    sendButton = document.getElementById('sendButton');
    statusElement = document.getElementById('status');
    modelSelect = document.getElementById('modelSelect');
    
    // è¦ç´ ãŒå–å¾—ã§ãã¦ã„ã‚‹ã‹ç¢ºèª
    if (!messagesDiv || !messageInput || !sendButton) {
        console.error('âŒ å¿…é ˆã®DOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('  messagesDiv:', messagesDiv);
        console.error('  messageInput:', messageInput);
        console.error('  sendButton:', sendButton);
        return;
    }
    
    loadFromLocalStorage();
    loadUserProfile();
    // ãƒŠãƒ¬ãƒƒã‚¸ã¯è‡ªå‹•èª­ã¿è¾¼ã¿ã—ãªã„
    // loadCompanyKnowledge();
    loadModels();
    checkConnection();
    
    // UIè¦ç´ ã®åˆæœŸåŒ–ã‚’ç¢ºèª
    initializeUIElements();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    setupEventListeners();
    
    // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒ
    restoreSettings();
    
    setInterval(checkConnection, 30000);
    setInterval(saveToLocalStorage, 10000); // 10ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‰ã˜ã‚‹å‰ã«ä¿å­˜
    window.addEventListener('beforeunload', saveToLocalStorage);
    
    // åˆå›ã¾ãŸã¯ä¼šè©±ãŒç©ºã®å ´åˆã¯ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’è¡¨ç¤º
    if (!messages || messages.length === 0) {
        showWelcomeScreen();
    }
    
    console.log('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
}

// UIè¦ç´ ã®åˆæœŸåŒ–ã‚’ç¢ºèª
function initializeUIElements() {
    const elements = [
        'knowledgeToggle',
        'voiceToggle', 
        'speakToggle',
        'knowledgeStatus',
        'messageInput',
        'sendButton'
    ];
    
    let missingElements = [];
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            missingElements.push(id);
        }
    });
    
    if (missingElements.length > 0) {
        console.error('âŒ UIè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', missingElements);
    } else {
        console.log('âœ… ã™ã¹ã¦ã®UIè¦ç´ ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
function setupEventListeners() {
    console.log('ğŸ“ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šä¸­...');
    
    // é€ä¿¡ãƒœã‚¿ãƒ³
    const sendBtn = document.getElementById('sendButton');
    if (sendBtn) {
        sendBtn.addEventListener('click', () => {
            console.log('é€ä¿¡ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            if (window.sendMessage) {
                window.sendMessage();
            } else {
                sendMessage();
            }
        });
        console.log('âœ… é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    } else {
        console.error('âŒ é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³
    const newChatBtn = document.getElementById('newChatButton');
    if (newChatBtn) {
        newChatBtn.addEventListener('click', () => {
            console.log('æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            startNewChat();
        });
        console.log('âœ… æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    } else {
        console.error('âŒ æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // ãƒŠãƒ¬ãƒƒã‚¸ãƒˆã‚°ãƒ«
    const knowledgeToggle = document.getElementById('knowledgeToggle');
    if (knowledgeToggle) {
        knowledgeToggle.addEventListener('change', window.toggleKnowledge);
        console.log('âœ… ãƒŠãƒ¬ãƒƒã‚¸ãƒˆã‚°ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    }
    
    // éŸ³å£°å…¥åŠ›ãƒˆã‚°ãƒ«
    const voiceToggle = document.getElementById('voiceToggle');
    if (voiceToggle) {
        voiceToggle.addEventListener('change', window.toggleVoice);
        console.log('âœ… éŸ³å£°å…¥åŠ›ãƒˆã‚°ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    }
    
    // èª­ã¿ä¸Šã’ãƒˆã‚°ãƒ«
    const speakToggle = document.getElementById('speakToggle');
    if (speakToggle) {
        speakToggle.addEventListener('change', window.toggleSpeak);
        console.log('âœ… èª­ã¿ä¸Šã’ãƒˆã‚°ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    const msgInput = document.getElementById('messageInput');
    if (msgInput) {
        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (window.sendMessage) {
                    window.sendMessage();
                } else {
                    sendMessage();
                }
            }
        });
        
        msgInput.addEventListener('input', () => {
            msgInput.style.height = 'auto';
            msgInput.style.height = msgInput.scrollHeight + 'px';
        });
        console.log('âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    }
    
    console.log('âœ… ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šå®Œäº†');
}

// ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢è¡¨ç¤º
function showWelcomeScreen() {
    messagesDiv.innerHTML = `
        <div class="welcome-message">
            <h2>AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¸ã‚ˆã†ã“ã</h2>
            <p>ä½•ã§ã‚‚ãŠèããã ã•ã„ã€‚</p>
            ${userProfile.name ? `<p>ã“ã‚“ã«ã¡ã¯ã€${userProfile.name}ã•ã‚“ï¼</p>` : ''}
            <div class="quick-actions">
                <button onclick="showProfile()">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š</button>
            </div>
            <div class="info" style="margin-top: 20px;">
                <p>ğŸ“ <strong>Markdownå¯¾å¿œ</strong> - è¡¨ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒãã‚Œã„ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                <p>ğŸ’¾ <strong>è‡ªå‹•ä¿å­˜</strong> - ä¼šè©±ã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
                <p>ğŸ“š <strong>ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸</strong> - ç™»éŒ²ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•å‚ç…§ã—ã¾ã™</p>
            </div>
        </div>
    `;
}

// æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
function startNewChat() {
    console.log('ğŸ†• æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹');
    
    // ç¾åœ¨ã®ä¼šè©±ã‚’å±¥æ­´ã«ä¿å­˜
    if (messages.length > 0) {
        chatHistory[currentChatId] = [...messages];
        saveToLocalStorage();
    }
    
    // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆIDã‚’ç”Ÿæˆ
    currentChatId = generateChatId();
    messages = [];
    
    // UIã‚’ã‚¯ãƒªã‚¢
    messagesDiv.innerHTML = '';
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    // ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã‚‚ã‚¯ãƒªã‚¢
    if (window.clearAttachedFiles) {
        window.clearAttachedFiles();
    }
    
    // ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’è¡¨ç¤º
    showWelcomeScreen();
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
    saveToLocalStorage();
    
    console.log('âœ… æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆæº–å‚™å®Œäº†');
}

// ãƒãƒ£ãƒƒãƒˆIDç”Ÿæˆ
function generateChatId() {
    return 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(2);
}

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
function loadFromLocalStorage() {
    try {
        const savedHistory = localStorage.getItem('chatHistory');
        if (savedHistory) {
            chatHistory = JSON.parse(savedHistory);
            renderChatHistory();
        }
        
        const savedCurrent = localStorage.getItem('currentChat');
        if (savedCurrent) {
            const data = JSON.parse(savedCurrent);
            currentChatId = data.id;
            messages = data.messages || [];
            
            // ä¼šè©±ã‚’å¾©å…ƒ
            if (messages.length > 0) {
                messagesDiv.innerHTML = '';
                messages.forEach(msg => {
                    addMessage(msg.role, msg.content, false);
                });
            }
        }
        
        console.log('âœ… ä¼šè©±å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
    } catch (error) {
        console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
function saveToLocalStorage() {
    try {
        // ç¾åœ¨ã®ä¼šè©±ã‚’ä¿å­˜
        localStorage.setItem('currentChat', JSON.stringify({
            id: currentChatId,
            messages: messages,
            timestamp: new Date().toISOString()
        }));
        
        // å±¥æ­´ã‚’ä¿å­˜
        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        
        console.log('ğŸ’¾ è‡ªå‹•ä¿å­˜å®Œäº†');
    } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function loadUserProfile() {
    const saved = localStorage.getItem('userProfile');
    if (saved) {
        userProfile = JSON.parse(saved);
    } else {
        // åˆå›ã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’ä¿ƒã™
        userProfile = {
            name: '',
            department: '',
            preferences: [],
            context: ''
        };
    }
}

// ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸èª­ã¿è¾¼ã¿ï¼ˆãƒŠãƒ¬ãƒƒã‚¸ãƒœã‚¿ãƒ³ãŒONã®æ™‚ã®ã¿ï¼‰
async function loadCompanyKnowledge() {
    // ãƒŠãƒ¬ãƒƒã‚¸ãƒœã‚¿ãƒ³ãŒONã®æ™‚ã®ã¿èª­ã¿è¾¼ã‚€
    if (!isKnowledgeEnabled) {
        console.log('ãƒŠãƒ¬ãƒƒã‚¸æ©Ÿèƒ½ã¯ç„¡åŠ¹ã§ã™');
        companyKnowledge = [];
        return;
    }
    
    try {
        // ç¤¾å†…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰èª­ã¿è¾¼ã¿
        const response = await fetch('http://localhost:3001/api/knowledge');
        if (response.ok) {
            companyKnowledge = await response.json();
            console.log(`ğŸ“š ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ ${companyKnowledge.length}ä»¶èª­ã¿è¾¼ã¿`);
        }
    } catch (error) {
        console.log('ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ã¯å¾Œã§è¨­å®šã§ãã¾ã™');
    }
}

// Markdownãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã‚’ä¸€åº¦ã ã‘åˆæœŸåŒ–
let markdownRenderer = null;

// Markdownãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ã®åˆæœŸåŒ–
function initializeMarkdownRenderer() {
    if (markdownRenderer) return;
    
    markdownRenderer = new marked.Renderer();
    
    markdownRenderer.code = function(code, language) {
        const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
        const lang = language || 'plaintext';
        
        return `
            <div class="code-block-wrapper">
                <div class="code-block-header">
                    <span class="code-language">${lang}</span>
                    <button class="copy-code-btn" onclick="copyCode('${codeId}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                        ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
                <pre><code id="${codeId}" class="language-${lang}">${escapeHtml(code)}</code></pre>
            </div>
        `;
    };
    
    marked.setOptions({
        renderer: markdownRenderer,
        highlight: false // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã¯ä¸€æ—¦ç„¡åŠ¹åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ï¼‰
    });
}

// Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
function renderMarkdown(text) {
    if (!markdownRenderer) {
        initializeMarkdownRenderer();
    }
    
    const html = marked.parse(text);
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 
                      'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'a', 'table', 
                      'thead', 'tbody', 'tr', 'th', 'td', 'img', 'div', 'span', 'button', 'svg', 'rect', 'path'],
        ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'title', 'class', 'id', 'onclick', 
                       'width', 'height', 'viewBox', 'fill', 'stroke', 'stroke-width', 'x', 'y', 
                       'rx', 'ry', 'd', 'stroke-linecap', 'stroke-linejoin']
    });
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
window.copyCode = function(codeId) {
    const codeElement = document.getElementById(codeId);
    if (codeElement) {
        const text = codeElement.textContent;
        navigator.clipboard.writeText(text).then(() => {
            // ã‚³ãƒ”ãƒ¼æˆåŠŸã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            const btn = event.target.closest('.copy-code-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†';
            btn.style.color = '#10b981';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.color = '';
            }, 2000);
        }).catch(err => {
            console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
        });
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ - setupEventListenerså†…ã«ç§»å‹•æ¸ˆã¿

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message || isGenerating) return;
    
    const selectedModel = modelSelect.value;
    if (!selectedModel) {
        alert('ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    addMessage('user', message);
    
    isGenerating = true;
    sendButton.disabled = true;
    
    const typingDiv = addTypingIndicator();
    
    try {
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ï¼ˆãƒŠãƒ¬ãƒƒã‚¸ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        // contextã¯å‰Šé™¤ã—ã€useKnowledgeãƒ•ãƒ©ã‚°ã®ã¿é€ä¿¡
        
        const response = await fetch('http://localhost:3001/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                model: selectedModel,
                history: messages.slice(-10),
                useKnowledge: Boolean(isKnowledgeEnabled),  // ç¢ºå®Ÿã«ãƒ–ãƒ¼ãƒ«å€¤ã‚’é€ä¿¡
                userProfile: userProfile
            })
        });
        
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let assistantMessage = '';
        
        removeTypingIndicator(typingDiv);
        const assistantDiv = addMessage('assistant', '');
        const contentDiv = assistantDiv.querySelector('.message-content');
        
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        if (data.content) {
                            assistantMessage += data.content;
                            contentDiv.innerHTML = renderMarkdown(assistantMessage);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    } catch (e) {
                        console.error('Error parsing SSE data:', e);
                    }
                }
            }
        }
        
        messages.push({ role: 'assistant', content: assistantMessage });
        updateChatHistory();
        saveToLocalStorage(); // è‡ªå‹•ä¿å­˜
        
    } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator(typingDiv);
        addMessage('assistant', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        setStatus('error');
    } finally {
        isGenerating = false;
        sendButton.disabled = false;
    }
}

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ï¼ˆå‰Šé™¤æ¸ˆã¿ - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å‡¦ç†ï¼‰
// function buildContext(message) { ... }
// ã“ã®é–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãƒŠãƒ¬ãƒƒã‚¸æ¤œç´¢ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¡Œã„ã¾ã™ã€‚

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
function addMessage(role, content, save = true) {
    if (messagesDiv.querySelector('.welcome-message')) {
        messagesDiv.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = role === 'user' ? (userProfile.name || 'You') : 'AI';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (role === 'assistant' && content) {
        contentDiv.innerHTML = renderMarkdown(content);
    } else {
        contentDiv.textContent = content;
    }
    
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = new Date().toLocaleTimeString();
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(timestamp);
    messagesDiv.appendChild(messageDiv);
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    if (role === 'user' && save) {
        messages.push({ role, content });
    }
    
    return messageDiv;
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message assistant typing';
    typingDiv.innerHTML = `
        <div class="message-avatar">AI</div>
        <div class="message-content">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    return typingDiv;
}

function removeTypingIndicator(typingDiv) {
    if (typingDiv && typingDiv.parentNode) {
        typingDiv.remove();
    }
}

// æ–°è¦ãƒãƒ£ãƒƒãƒˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.newChat = function() {
    // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã‚’å±¥æ­´ã«ä¿å­˜
    if (messages.length > 0) {
        updateChatHistory();
        saveToLocalStorage();
    }
    
    currentChatId = generateChatId();
    messages = [];
    showWelcomeScreen();
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´æ›´æ–°
function updateChatHistory() {
    if (messages.length === 0) return;
    
    chatHistory[currentChatId] = {
        title: messages[0]?.content?.substring(0, 30) + '...' || 'æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ',
        messages: messages,
        timestamp: new Date().toISOString()
    };
    renderChatHistory();
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderChatHistory() {
    const historyDiv = document.getElementById('chatHistory');
    if (!historyDiv) return;
    
    historyDiv.innerHTML = '';
    
    const sortedChats = Object.entries(chatHistory)
        .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp))
        .slice(0, 20); // æœ€æ–°20ä»¶
    
    sortedChats.forEach(([id, chat]) => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.innerHTML = `
            <div class="chat-item-title" contenteditable="false" data-chat-id="${id}">${chat.title}</div>
            <div class="chat-item-date">${new Date(chat.timestamp).toLocaleDateString()}</div>
        `;
        
        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†å¯èƒ½ã«
        const titleDiv = chatItem.querySelector('.chat-item-title');
        titleDiv.ondblclick = (e) => {
            e.stopPropagation();
            titleDiv.contentEditable = 'true';
            titleDiv.focus();
            
            // å…¨æ–‡é¸æŠ
            const range = document.createRange();
            range.selectNodeContents(titleDiv);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        };
        
        titleDiv.onblur = () => {
            titleDiv.contentEditable = 'false';
            const newTitle = titleDiv.textContent.trim();
            if (newTitle && newTitle !== chat.title) {
                chat.title = newTitle;
                saveToLocalStorage();
            }
        };
        
        titleDiv.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                titleDiv.blur();
            }
        };
        
        chatItem.onclick = () => {
            if (titleDiv.contentEditable !== 'true') {
                loadChat(id);
            }
        };
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'chat-delete-btn';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteChat(id);
        };
        chatItem.appendChild(deleteBtn);
        
        historyDiv.appendChild(chatItem);
    });
}

// ãƒãƒ£ãƒƒãƒˆèª­ã¿è¾¼ã¿
function loadChat(chatId) {
    // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã¨åŒã˜ãªã‚‰ä½•ã‚‚ã—ãªã„
    if (chatId === currentChatId) return;
    
    if (messages.length > 0) {
        updateChatHistory();
    }
    
    const chat = chatHistory[chatId];
    if (!chat) return;
    
    currentChatId = chatId;
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ·±ãã‚³ãƒ”ãƒ¼ã—ã¦è¤‡è£½ã‚’é˜²ã
    messages = JSON.parse(JSON.stringify(chat.messages || []));
    
    messagesDiv.innerHTML = '';
    messages.forEach(msg => {
        addMessage(msg.role, msg.content, false);
    });
    
    saveToLocalStorage();
}

// ãƒãƒ£ãƒƒãƒˆå‰Šé™¤
function deleteChat(chatId) {
    if (confirm('ã“ã®ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        delete chatHistory[chatId];
        
        // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã‚’å‰Šé™¤ã—ãŸå ´åˆã€æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹
        if (chatId === currentChatId) {
            currentChatId = generateChatId();
            messages = [];
            showWelcomeScreen();
        }
        
        renderChatHistory();
        saveToLocalStorage();
    }
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯ç®¡ç†è€…ç”»é¢ã§ã®ã¿åˆ©ç”¨å¯èƒ½
// ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿
// function exportAllChats() - å‰Šé™¤æ¸ˆã¿

// ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.showProfile = function() {
    const name = prompt('ãŠåå‰:', userProfile.name || '');
    const department = prompt('éƒ¨ç½²:', userProfile.department || '');
    const context = prompt('AIã«è¦šãˆã¦ãŠã„ã¦ã»ã—ã„ã“ã¨:', userProfile.context || '');
    
    if (name !== null) {
        userProfile.name = name;
        userProfile.department = department;
        userProfile.context = context;
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        alert('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    }
}

// ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ç®¡ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.showKnowledge = async function() {
    window.location.href = 'knowledge-manager.html';
}

// ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿
async function loadModels() {
    try {
        const response = await fetch('http://localhost:3001/api/models');
        const data = await response.json();
        
        if (data.models && data.models.length > 0) {
            availableModels = data.models;
            modelSelect.innerHTML = '';
            
            const providers = {};
            data.models.forEach(model => {
                if (!providers[model.provider]) {
                    providers[model.provider] = [];
                }
                providers[model.provider].push(model);
            });
            
            Object.entries(providers).forEach(([provider, models]) => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = provider.toUpperCase();
                
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.description || model.name;
                    optgroup.appendChild(option);
                });
                
                modelSelect.appendChild(optgroup);
            });
            
            // å‰å›é¸æŠã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’å¾©å…ƒ
            const savedModel = localStorage.getItem('selectedModel');
            if (savedModel && data.models.find(m => m.name === savedModel)) {
                modelSelect.value = savedModel;
            } else if (data.models.find(m => m.name === 'gemini-flash')) {
                modelSelect.value = 'gemini-flash';
            }
        }
    } catch (error) {
        console.error('Error loading models:', error);
        modelSelect.innerHTML = '<option value="">ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“</option>';
    }
}

// ãƒ¢ãƒ‡ãƒ«é¸æŠä¿å­˜
modelSelect.addEventListener('change', () => {
    localStorage.setItem('selectedModel', modelSelect.value);
});

// ãƒˆã‚°ãƒ«æ©Ÿèƒ½ã®å®Ÿè£…ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.toggleKnowledge = function() {
    isKnowledgeEnabled = !isKnowledgeEnabled;
    const btn = document.getElementById('knowledgeToggle');
    const status = document.getElementById('knowledgeStatus');
    
    console.log('ãƒŠãƒ¬ãƒƒã‚¸ãƒˆã‚°ãƒ«:', isKnowledgeEnabled);
    
    if (isKnowledgeEnabled) {
        btn.classList.add('active');
        status.style.display = 'flex';
        status.querySelector('.status-text').textContent = 'ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹æ¥ç¶šä¸­';
        
        // ãƒŠãƒ¬ãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ã®å†èª­ã¿è¾¼ã¿
        loadCompanyKnowledge();
    } else {
        btn.classList.remove('active');
        status.style.display = 'none';
        // ãƒŠãƒ¬ãƒƒã‚¸ã‚’ã‚¯ãƒªã‚¢
        companyKnowledge = [];
    }
    
    localStorage.setItem('knowledgeEnabled', String(isKnowledgeEnabled));
}

window.toggleVoice = function() {
    isVoiceEnabled = !isVoiceEnabled;
    const btn = document.getElementById('voiceToggle');
    const voiceBtn = document.getElementById('voiceButton');
    
    if (isVoiceEnabled) {
        btn.classList.add('active');
        voiceBtn.style.display = 'flex';
        initializeSpeechRecognition();
    } else {
        btn.classList.remove('active');
        voiceBtn.style.display = 'none';
        if (recognition) {
            recognition.stop();
        }
    }
    
    localStorage.setItem('voiceEnabled', isVoiceEnabled);
}

window.toggleSpeak = function() {
    isSpeakEnabled = !isSpeakEnabled;
    const btn = document.getElementById('speakToggle');
    
    if (isSpeakEnabled) {
        btn.classList.add('active');
    } else {
        btn.classList.remove('active');
        // ç¾åœ¨ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
        if (synthesis.speaking) {
            synthesis.cancel();
        }
    }
    
    localStorage.setItem('speakEnabled', isSpeakEnabled);
}

// éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
function initializeSpeechRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chrome/Edgeã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    recognition.onstart = () => {
        isRecording = true;
        const voiceBtn = document.getElementById('voiceButton');
        voiceBtn.classList.add('recording');
        voiceBtn.querySelector('.recording-indicator').style.display = 'block';
    };
    
    recognition.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        messageInput.value = finalTranscript || interimTranscript;
        messageInput.style.height = 'auto';
        messageInput.style.height = messageInput.scrollHeight + 'px';
    };
    
    recognition.onend = () => {
        isRecording = false;
        const voiceBtn = document.getElementById('voiceButton');
        voiceBtn.classList.remove('recording');
        voiceBtn.querySelector('.recording-indicator').style.display = 'none';
    };
    
    recognition.onerror = (event) => {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        if (event.error === 'no-speech') {
            alert('éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        }
    };
}

// éŸ³å£°å…¥åŠ›é–‹å§‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.startVoiceInput = function() {
    if (!recognition) {
        initializeSpeechRecognition();
    }
    
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
    }
}

// ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’
function speakText(text) {
    if (!isSpeakEnabled || !text) return;
    
    // Markdownã‚’é™¤å»ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«
    const plainText = text
        .replace(/```[\s\S]*?```/g, 'ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯')
        .replace(/[#*`_~]/g, '')
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
        .replace(/!\[([^\]]*)\]\([^)]+\)/g, 'ç”»åƒ');
    
    const utterance = new SpeechSynthesisUtterance(plainText);
    utterance.lang = 'ja-JP';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    utterance.volume = 0.8;
    
    synthesis.speak(utterance);
}

// åˆæœŸè¨­å®šã®å¾©å…ƒ - initializeAppå†…ã«çµ±åˆ
function restoreSettings() {
    // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’å¾©å…ƒï¼ˆãƒŠãƒ¬ãƒƒã‚¸ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFï¼‰
    const knowledgeEnabled = localStorage.getItem('knowledgeEnabled') === 'true';
    const voiceEnabled = localStorage.getItem('voiceEnabled') === 'true';
    const speakEnabled = localStorage.getItem('speakEnabled') === 'true';
    
    console.log('åˆæœŸè¨­å®šå¾©å…ƒ:');
    console.log('  ãƒŠãƒ¬ãƒƒã‚¸:', knowledgeEnabled);
    console.log('  éŸ³å£°:', voiceEnabled);
    console.log('  èª­ã¿ä¸Šã’:', speakEnabled);
    
    // ç›´æ¥çŠ¶æ…‹ã‚’è¨­å®šï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
    // ãƒŠãƒ¬ãƒƒã‚¸è¨­å®š
    isKnowledgeEnabled = knowledgeEnabled;
    const knowledgeBtn = document.getElementById('knowledgeToggle');
    const knowledgeStatus = document.getElementById('knowledgeStatus');
    if (knowledgeBtn) {
        if (knowledgeEnabled) {
            knowledgeBtn.classList.add('active');
        } else {
            knowledgeBtn.classList.remove('active');
        }
    }
    if (knowledgeStatus) {
        knowledgeStatus.style.display = knowledgeEnabled ? 'inline' : 'none';
    }
    
    // éŸ³å£°è¨­å®š
    isVoiceEnabled = voiceEnabled;
    const voiceBtn = document.getElementById('voiceToggle');
    if (voiceBtn) {
        if (voiceEnabled) {
            voiceBtn.classList.add('active');
            // éŸ³å£°èªè­˜ã®åˆæœŸåŒ–ã¯å¿…è¦ã«å¿œã˜ã¦å¾Œã§
        } else {
            voiceBtn.classList.remove('active');
        }
    }
    
    // èª­ã¿ä¸Šã’è¨­å®š
    isSpeakEnabled = speakEnabled;
    const speakBtn = document.getElementById('speakToggle');
    if (speakBtn) {
        if (speakEnabled) {
            speakBtn.classList.add('active');
        } else {
            speakBtn.classList.remove('active');
        }
    }
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('knowledgeEnabled', knowledgeEnabled);
    localStorage.setItem('voiceEnabled', voiceEnabled);
    localStorage.setItem('speakEnabled', speakEnabled);
}

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
function setStatus(status) {
    if (status === 'error') {
        statusElement.textContent = 'â— æ¥ç¶šã‚¨ãƒ©ãƒ¼';
        statusElement.className = 'status error';
    } else {
        statusElement.textContent = 'â— æ¥ç¶šä¸­';
        statusElement.className = 'status';
    }
}

// æ¥ç¶šãƒã‚§ãƒƒã‚¯
async function checkConnection() {
    try {
        const response = await fetch('http://localhost:3001/api/health');
        const data = await response.json();
        if (response.ok) {
            setStatus('connected');
        } else {
            setStatus('error');
        }
    } catch {
        setStatus('error');
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜æ©Ÿèƒ½
let attachedFiles = [];

// ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã®åˆæœŸåŒ–
function initializeFileAttachment() {
    const fileInput = document.getElementById('fileInput');
    const filePreview = document.getElementById('filePreview');
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
async function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    const filePreview = document.getElementById('filePreview');
    
    for (const file of files) {
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBä»¥ä¸‹ï¼‰
        if (file.size > 10 * 1024 * 1024) {
            alert(`${file.name} ã¯10MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
            continue;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        const fileData = await readFile(file);
        attachedFiles.push({
            name: file.name,
            type: file.type,
            size: file.size,
            data: fileData
        });
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¿½åŠ 
        addFilePreview(file.name, attachedFiles.length - 1);
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    if (attachedFiles.length > 0) {
        filePreview.style.display = 'flex';
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
    event.target.value = '';
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            if (file.type.startsWith('image/')) {
                resolve(e.target.result); // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            } else {
                resolve(e.target.result); // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
            }
        };
        
        reader.onerror = reject;
        
        if (file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¿½åŠ 
function addFilePreview(fileName, index) {
    const filePreview = document.getElementById('filePreview');
    const previewItem = document.createElement('div');
    previewItem.className = 'file-preview-item';
    previewItem.innerHTML = `
        <span>${fileName}</span>
        <span class="remove-file" onclick="removeFile(${index})">Ã—</span>
    `;
    filePreview.appendChild(previewItem);
}

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
window.removeFile = function(index) {
    attachedFiles.splice(index, 1);
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†æç”»
    const filePreview = document.getElementById('filePreview');
    filePreview.innerHTML = '';
    
    attachedFiles.forEach((file, i) => {
        addFilePreview(file.name, i);
    });
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªããªã£ãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
    if (attachedFiles.length === 0) {
        filePreview.style.display = 'none';
    }
}

// ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã®ãƒ©ãƒƒãƒ‘ãƒ¼
async function sendMessageWrapper() {
    const message = messageInput.value.trim();
    if (!message && attachedFiles.length === 0) return;
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ·»ä»˜æƒ…å ±ã‚’è¿½åŠ 
    let enhancedMessage = message;
    if (attachedFiles.length > 0) {
        enhancedMessage += '\n\nã€æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã€‘\n';
        for (const file of attachedFiles) {
            if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.md') || 
                file.name.endsWith('.js') || file.name.endsWith('.py') || file.name.endsWith('.json')) {
                enhancedMessage += `\nãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}\n\`\`\`\n${file.data}\n\`\`\`\n`;
            } else if (file.type.startsWith('image/')) {
                enhancedMessage += `\nç”»åƒ: ${file.name}\n`;
            } else {
                enhancedMessage += `\nãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${Math.round(file.size / 1024)}KB)\n`;
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
        attachedFiles = [];
        const filePreview = document.getElementById('filePreview');
        filePreview.innerHTML = '';
        filePreview.style.display = 'none';
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚çš„ã«å¤‰æ›´
        messageInput.value = enhancedMessage;
    }
    
    // å…ƒã®sendMessageé–¢æ•°ã‚’å‘¼ã³å‡ºã™
    await sendMessage();
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ï¼ˆHTMLå†…ã®onclickã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹ï¼‰
window.sendMessage = sendMessageWrapper;
window.newChat = startNewChat;
// toggleKnowledge, toggleVoice, toggleSpeak, startVoiceInputã¯æ—¢ã«å®šç¾©æ¸ˆã¿

// ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    initializeFileAttachment();
    initializeMarkdownRenderer();
});